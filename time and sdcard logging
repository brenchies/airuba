

#include <SPI.h>
#include <SD.h>


String my_directory = "log";// folder name where to save samples
String DATE[3] = {"2017", "9", "28"};// date, makes log file name "yy/mm/dd"
String my_file;/// directroy + name of file to write to write log to;
String time_holder;
uint8_t seconds, minutes = 5, hours = 21;
int SDSS = 4; // sdcard chip select

File myFile;

void setup() {
 Serial.begin(250000);
SD_ini();

my_file = my_directory+"/"+DATE[0]+DATE[1]+DATE[2]+".txt";
}

void loop() {
  // put your main code here, to run repeatedly:
if(Serial.available() > 0){
  String data = Serial.readString();
  data.trim();
  Serial.println( parser(data));
}
timef();
}

String parser(String data){
 static String parse_keywords[6] = { "mkdir", "name", "log", "read", "open", "close"};
 String returns;// data string to be passsed
int p, parsed = -1;

 for ( int i = 0; i < 5; i++){
  uint8_t p = data.indexOf(parse_keywords[i]);
  if(p > -1 && p == 0){ 
    parsed = i;
    data = data.substring(data.indexOf(parse_keywords[i]) + parse_keywords[parsed].length() + 1);
    break;
  }
 }

 

 switch(parsed){
  default:
  returns = " no valid keyword found ";
  break;
  case 0:
  returns = makedir(data);
  break;
  case 1:
  returns = myFile.name();
  break;
  case 2:
  returns = logger(data);
  break;
  case 3:
  returns = reader(data);
  break;
 }

  return returns;
}





void SD_ini(){
  
 if(!SD.begin(SDSS)){
  Serial.println("No SD card available");
 }

(makedir("/" + my_directory));
(makefile(my_directory+"/"+DATE[0]+DATE[1]+DATE[2]+".txt"));
//Serial.println("SD Ini done");
  
}


String makedir(String data){

if( !SD.exists(data)){// make directory if not available
  if( SD.mkdir(data) ){data =  " Created directory: "+data;}
}else{ data = "directory exists"; }

  return data;
}

String makefile( String data){

   if( !SD.exists(data)){// make directory if not available
  myFile = SD.open(data, FILE_WRITE);
  myFile.close();
  data = "Created file: "+data;
 }else{ data = "file exists "; }

 return data;
}

String logger(String data){
myFile = SD.open(my_file, FILE_WRITE);
myFile.println(data +" "+ time_holder);
myFile.close();

return "wrote to: "+my_file;
}

String reader(String data){

myFile = SD.open(my_file, FILE_READ);
if (myFile) {
    Serial.println(data);
    while (myFile.available()) {
     Serial.write(myFile.read());
    }
}
myFile.close();

return "done";
}




void timef(){
  static unsigned long time_timer;

  if( millis() - time_timer > 1000){
    time_timer = millis();
    if( seconds < 59 ){
      seconds++;
    }else{
      seconds = 0;

      if( minutes < 59){
        minutes++;
      }else{
        minutes = 0;
        if( hours < 24){
          hours++;
        }else{
          hours = 0;
        }
        
      }

    
    
  }

  time_holder = String(hours)+":"+String(minutes)+":"+String(seconds);
  }
  
}
